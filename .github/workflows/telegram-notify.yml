name: Notify

permissions:
  contents: read

on:
  push:
    branches:
      - main

jobs:
  notify:
    name: Notify via Telegram
    runs-on: ubuntu-latest
    steps:
      - name: Notify
        env:
          COMMITS: ${{ toJson(github.event.commits) }}
        run: |
          TEMPLATE='.[] | "[\(.id[:8])](\(.url)) â€¢ [\(.author.username)](https://github.com/\(.author.username))
          \(.message | gsub("(?<m>[_*\\[\\]()~>#+\\-=|{}.!`'"'"'])"; "\\\(.m)"))
          "'
          TEXT=$(
            printenv COMMITS | jq -r "$TEMPLATE"
            printf 'ðŸ“… @Persian\_Calendar'
          ) \
          curl -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -H 'Content-Type: application/json' \
            -d '{"disable_web_page_preview":true, "text":"'"$TEXT"'", "chat_id": ${{ secrets.TELEGRAM_CHAT_ID }}, "parse_mode":"MarkdownV2" }' \
            --data-binary @-
